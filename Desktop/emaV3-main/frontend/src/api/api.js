import axios from "axios";

/** üîß Cr√©ation d'une instance Axios avec baseURL depuis .env ou localhost */
const isProduction = window.location.hostname !== 'localhost';
const baseURL = isProduction
  ? 'https://ema-v3-backend.onrender.com/api'
  : 'http://localhost:10000/api'; // üîß CORRECTION: Port 10000 au lieu de 5000

console.log('=== API Configuration ===');
console.log('Environment:', isProduction ? 'Production' : 'Development');
console.log('Base URL:', baseURL);

const api = axios.create({
  baseURL,
  headers: { 
    "Content-Type": "application/json",
    "Accept": "application/json"
  },
  timeout: 30000, // üÜï Timeout de 30 secondes
});

/** üîê Ajout automatique du token dans les en-t√™tes Authorization */
api.interceptors.request.use(
  (config) => {
    console.log('=== API Request ===');
    console.log('URL:', `${config.baseURL}${config.url}`);
    console.log('Method:', config.method?.toUpperCase());
    console.log('Headers:', config.headers);
    
    // Ne pas logger les donn√©es sensibles en production
    if (!isProduction) {
      console.log('Data:', config.data);
    }
    
    const token = localStorage.getItem("token");
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
      console.log('‚úÖ Token found and added to headers');
    } else {
      console.log('‚ö†Ô∏è No token found in localStorage');
    }
    return config;
  },
  (error) => {
    console.error('=== API Request Error ===');
    console.error('Error:', error);
    return Promise.reject(error);
  }
);

api.interceptors.response.use(
  (response) => {
    console.log('=== API Response Success ===');
    console.log('‚úÖ Status:', response.status);
    console.log('‚úÖ URL:', response.config.url);
    
    // Ne pas logger toutes les donn√©es en production
    if (!isProduction) {
      console.log('Data:', response.data);
    }
    
    return response;
  },
  (error) => {
    console.error('=== API Error ===');
    
    if (error.response) {
      // Le serveur a r√©pondu avec un code d'erreur
      console.error('=== API Response Error ===');
      console.error('‚ùå Status:', error.response.status);
      console.error('‚ùå URL:', error.config?.url);
      console.error('‚ùå Data:', error.response.data);
      
      // Gestion sp√©cifique des erreurs
      switch (error.response.status) {
        case 401:
          console.error('üîê Authentication error - Token may be expired or invalid');
          // Optionnel: rediriger vers login ou nettoyer le localStorage
          // localStorage.removeItem('token');
          // window.location.href = '/login';
          break;
        case 403:
          console.error('üö´ Permission denied - User may not have required role');
          break;
        case 404:
          console.error('üîç Resource not found - Check API endpoint');
          break;
        case 500:
          console.error('üî• Server error - Check backend logs');
          break;
        case 502:
          console.error('üåê Bad Gateway - Backend server may be down');
          break;
        case 503:
          console.error('‚è≥ Service Unavailable - Backend server is temporarily down');
          break;
        default:
          console.error(`‚ùì HTTP Error ${error.response.status}`);
      }
    } else if (error.request) {
      // La requ√™te a √©t√© faite mais pas de r√©ponse
      console.error('=== API Request Failed ===');
      console.error('üì° Request made but no response received');
      
      if (error.code === 'ECONNABORTED') {
        console.error('‚è∞ Request timeout');
      } else if (error.code === 'ERR_NETWORK') {
        console.error('üåê Network error - Check internet connection or CORS');
      } else if (error.code === 'ERR_BLOCKED_BY_CLIENT') {
        console.error('üõ°Ô∏è Request blocked by browser (ad blocker, etc.)');
      } else {
        console.error('‚ùì Unknown network error:', error.code);
      }
    } else {
      // Erreur dans la configuration de la requ√™te
      console.error('=== API Configuration Error ===');
      console.error('‚öôÔ∏è Error in request setup:', error.message);
    }
    
    // Stack trace uniquement en d√©veloppement
    if (!isProduction) {
      console.error('Stack:', error.stack);
    }
    
    return Promise.reject(error);
  }
);

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ RESIDENCES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

export const fetchResidences = async () => {
  try {
    const { data } = await api.get("/residences");
    return data;
  } catch (error) {
    console.error('Erreur lors du chargement des r√©sidences:', error.message);
    throw error;
  }
};

export const getResidenceById = async (id) => {
  try {
    if (!id) throw new Error('ID r√©sidence requis');
    const { data } = await api.get(`/residences/${id}`);
    return data;
  } catch (error) {
    console.error(`Erreur lors du chargement de la r√©sidence ${id}:`, error.message);
    throw error;
  }
};

export const createResidence = async (formData) => {
  try {
    const { data } = await api.post("/residences", formData, {
      headers: {
        "Content-Type": "multipart/form-data",
      },
    });
    return data;
  } catch (error) {
    console.error('Erreur lors de la cr√©ation de la r√©sidence:', error.message);
    throw error;
  }
};

export const updateResidence = async (id, formData) => {
  try {
    if (!id) throw new Error('ID r√©sidence requis');
    const { data } = await api.put(`/residences/${id}`, formData, {
      headers: {
        "Content-Type": "multipart/form-data",
      },
    });
    return data;
  } catch (error) {
    console.error(`Erreur lors de la mise √† jour de la r√©sidence ${id}:`, error.message);
    throw error;
  }
};

export const deleteResidence = async (id) => {
  try {
    if (!id) throw new Error('ID r√©sidence requis');
    const { data } = await api.delete(`/residences/${id}`);
    return data;
  } catch (error) {
    console.error(`Erreur lors de la suppression de la r√©sidence ${id}:`, error.message);
    throw error;
  }
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ANNONCES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

export const fetchAnnonces = async () => {
  try {
    const { data } = await api.get("/annonces");
    return data;
  } catch (error) {
    console.error('Erreur lors du chargement des annonces:', error.message);
    throw error;
  }
};

export const createAnnonce = async (formData) => {
  try {
    const { data } = await api.post("/annonces", formData, {
      headers: {
        "Content-Type": "multipart/form-data",
      },
    });
    return data;
  } catch (error) {
    console.error('Erreur lors de la cr√©ation de l\'annonce:', error.message);
    throw error;
  }
};

export const updateAnnonce = async (id, formData) => {
  try {
    if (!id) throw new Error('ID annonce requis');
    const { data } = await api.put(`/annonces/${id}`, formData, {
      headers: {
        "Content-Type": "multipart/form-data",
      },
    });
    return data;
  } catch (error) {
    console.error(`Erreur lors de la mise √† jour de l'annonce ${id}:`, error.message);
    throw error;
  }
};

export const deleteAnnonce = async (id) => {
  try {
    if (!id) throw new Error('ID annonce requis');
    const { data } = await api.delete(`/annonces/${id}`);
    return data;
  } catch (error) {
    console.error(`Erreur lors de la suppression de l'annonce ${id}:`, error.message);
    throw error;
  }
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ UTILISATEURS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

export const login = async (credentials) => {
  try {
    if (!credentials?.email || !credentials?.password) {
      throw new Error('Email et mot de passe requis');
    }
    const { data } = await api.post("/auth/login", credentials);
    
    // Sauvegarder le token si pr√©sent
    if (data.token) {
      localStorage.setItem('token', data.token);
      console.log('‚úÖ Token sauvegard√©');
    }
    
    return data;
  } catch (error) {
    console.error('Erreur lors de la connexion:', error.message);
    throw error;
  }
};

export const register = async (newUser) => {
  try {
    if (!newUser?.email || !newUser?.password || !newUser?.firstName || !newUser?.lastName) {
      throw new Error('Tous les champs requis doivent √™tre remplis');
    }
    const { data } = await api.post("/auth/register", newUser);
    return data;
  } catch (error) {
    console.error('Erreur lors de l\'inscription:', error.message);
    throw error;
  }
};

export const getUserProfile = async () => {
  try {
    const { data } = await api.get("/auth/profile");
    return data;
  } catch (error) {
    console.error('Erreur lors du chargement du profil:', error.message);
    throw error;
  }
};

export const logout = () => {
  try {
    localStorage.removeItem('token');
    console.log('‚úÖ D√©connexion r√©ussie');
  } catch (error) {
    console.error('Erreur lors de la d√©connexion:', error);
  }
};

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ R√âSERVATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

export const createReservation = async (payload) => {
  try {
    if (!payload) throw new Error('Donn√©es de r√©servation requises');
    const { data } = await api.post("/reservations", payload);
    return data;
  } catch (error) {
    console.error('Erreur lors de la cr√©ation de la r√©servation:', error.message);
    throw error;
  }
};

export const fetchReservations = async () => {
  try {
    const { data } = await api.get("/reservations");
    return data;
  } catch (error) {
    console.error('Erreur lors du chargement des r√©servations:', error.message);
    throw error;
  }
};

export const deleteReservation = async (id) => {
  try {
    if (!id) throw new Error('ID r√©servation requis');
    const { data } = await api.delete(`/reservations/${id}`);
    return data;
  } catch (error) {
    console.error(`Erreur lors de la suppression de la r√©servation ${id}:`, error.message);
    throw error;
  }
};

/** üì¶ Export de l'instance Axios si besoin d'appels custom */
export default api;